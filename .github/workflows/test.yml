name: Test Aletheia

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black

      - name: Run ruff
        run: ruff check agent_aletheia

      - name: Run black
        run: black --check agent_aletheia

  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install agent-sdk
        run: |
          # Clone agent-sdk if not in same workspace
          # For CI, we'll install from GitHub
          git clone https://github.com/stephenpeters/agent-sdk.git ../agent-sdk || true
          pip install -e ../agent-sdk

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: pytest tests/unit -v --cov=agent_aletheia --cov-report=xml

      - name: Run integration tests
        run: pytest tests/integration -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  interface-contract:
    name: API Interface Contract Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install agent-sdk
        run: |
          git clone https://github.com/stephenpeters/agent-sdk.git ../agent-sdk || true
          pip install -e ../agent-sdk

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Test API endpoints exist
        run: |
          pytest tests/integration/test_chat_routes.py::test_health_check -v
          pytest tests/integration/test_chat_routes.py::test_api_documentation_available -v

      - name: Test chat interface consistency
        run: |
          pytest tests/integration/test_chat_routes.py::test_send_message_creates_session -v
          pytest tests/integration/test_chat_routes.py::test_full_conversation_flow -v

      - name: Test 15-turn conversation (FRD KPI)
        run: |
          pytest tests/integration/test_conversation_coherence.py::test_fifteen_turn_conversation -v
